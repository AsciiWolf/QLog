<!DOCTYPE html>
<html>

<head>
  <title>Online Map</title>
  <meta charset="utf8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <script src="https://foldynl.github.io/QLog/js/L.MaidenheadConfWorked.js"></script>
  <script src="https://unpkg.com/@joergdietrich/leaflet.terminator"></script>
  <script src="https://foldynl.github.io/QLog/js/heatmap.js"></script>
  <script src="https://foldynl.github.io/QLog/js/leaflet-heatmap.js"></script>
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    html, body, #map {
      height: 100%;
    }
    .leaflet-tooltip {
        border: 0px;
        color: #232D45;
        box-shadow: none;
        margin: 0px !important;
        line-height: 10px;
        font-weight: 900;
      }
    .leaflet-tooltip-top:before,
    .leaflet-tooltip-bottom:before,
    .leaflet-tooltip-left:before,
    .leaflet-tooltip-right:before {
        border: none !important;
    }
    .leaflet-tooltip.muf-tooltip {
        border-radius: 20px;
        background-color: transparent;
        padding: 5px;
        font-weight: bold;
    }
  </style>
</head>

<body>

  <div id="map"></div>

  <script>
    var mapOptions = {
             center: [0,0],
             zoom: 2,
             minZoom: 2,
    }

    var grids_worked = [];
    var grids_confirmed = [];
    var mylocations = [];
    var locations = [];
    var map = L.map('map', mapOptions);
    var greenIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    var yellowIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    var homeIcon = new L.Icon({
      iconUrl: 'https://img.icons8.com/officel/30/000000/radio-tower.png',
      iconSize: [50, 50],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                {
                   attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
                }).addTo(map);

    var maidenheadConfWorked = L.maidenheadConfWorked({color : 'rgba(255, 0, 0, 0.5)'}).addTo(map);
    var grayline = L.terminator({fillOpacity: 0.2})

    setInterval(function(){updateTerminator(grayline)}, 60000);

    function updateTerminator(grayline)
    {
       var t2 = L.terminator({fillOpacity: 0.2});
       grayline.setLatLngs(t2.getLatLngs());
       grayline.redraw();
    }

    var auroraCfg = {
      // radius should be small ONLY if scaleRadius is true (or small radius is intended)
      "radius": 2,
      "maxOpacity": .3,
      // scales the radius based on map zoom
      "scaleRadius": true,
      // if set to false the heatmap uses the global maximum for colorization
      // if activated: uses the data maximum within the current map boundaries
      //   (there will always be a red spot with useLocalExtremas true)
      "useLocalExtrema": false,
      // which field name in your data represents the latitude - default "lat"
      latField: 'lat',
      // which field name in your data represents the longitude - default "lng"
      lngField: 'lng',
      // which field name in your data represents the data value - default "value"
      valueField: 'count'
    };

    var auroraLayer = new HeatmapOverlay(auroraCfg);

    var pathLayer = L.layerGroup().addTo(map);

    function drawPath(points) {
        pathLayer.clearLayers();
        if ( points.length > 0 ) {
            var polyLine = new L.Polyline(points, {color: 'Fuchsia', weight: 3, opacity: 0.7, smoothFactor: 1 });
            pathLayer.addLayer(polyLine);
            var bounds = polyLine.getBounds();
            map.fitBounds(bounds);
            var center = bounds.getCenter();
            map.panTo(center);
        }
    }

    var markersLayer = L.layerGroup().addTo(map);

    function drawPoints(points) {
        markersLayer.clearLayers();
        points.forEach(function(point) {
           var marker = L.marker([point[1], point[2]], {
                        icon: point[3]})
                        .bindPopup(point[0]);
           markersLayer.addLayer(marker);
        });
     }

     function flyToPoint(point, zoom) {
        map.flyTo([point[1], point[2]],zoom);
     }

     var markersLayer2 = L.layerGroup().addTo(map);

     function drawPointsGroup2(points) {
        markersLayer2.clearLayers();
        points.forEach(function(point) {
           var marker = L.marker([point[1], point[2]], {
                        icon: point[3]})
                        .bindPopup(point[0]);
           markersLayer2.addLayer(marker);
        });
     }

    function colorGradient(fadeFraction, rgbColor1, rgbColor2, rgbColor3) {
      var color1 = rgbColor1;
      var color2 = rgbColor2;
      var fade = fadeFraction;

      if (rgbColor3) {
        fade = fade * 2;

        if (fade >= 1) {
          fade -= 1;
          color1 = rgbColor2;
          color2 = rgbColor3;
        }
      }

      var diffRed = color2.red - color1.red;
      var diffGreen = color2.green - color1.green;
      var diffBlue = color2.blue - color1.blue;

      var gradient = {
        red: parseInt(Math.floor(color1.red + (diffRed * fade)), 10),
        green: parseInt(Math.floor(color1.green + (diffGreen * fade)), 10),
        blue: parseInt(Math.floor(color1.blue + (diffBlue * fade)), 10),
      };

      return 'rgb(' + gradient.red + ',' + gradient.green + ',' + gradient.blue + ')';
    }

    var mufLayer = L.layerGroup();

    function drawMuf(points) {
       var lowColor = {
            red: 0,
            green: 131,
            blue: 255
       };

       var mediumColor = {
           red: 255,
           green: 162,
           blue: 0
       };

       var highColor = {
           red: 255,
           green: 255,
           blue: 0
       };

       mufLayer.clearLayers();
       points.forEach(function(point) {
            var marker = new L.marker([point[1], point[2]], {opacity: 0.001 });
            marker.bindTooltip(point[0], {permanent: true, direction : 'bottom', offset: [-16, 8], className: 'muf-tooltip' });
            const oldValue = parseFloat(point[0]);
            const oldMin = 0; const oldMax = 50;
            const newMin = 0; const newMax = 1;
            const newValue = (oldValue - oldMin) / (oldMax - oldMin) * (newMax - newMin) + newMin;
            const color = colorGradient(newValue, lowColor, mediumColor, highColor);

            marker.getTooltip().setContent(`<div style="background-color: ${color};border-radius: 20px;padding: 5px;font-weight: bold;">${marker.getTooltip().getContent()}</div>`);
            mufLayer.addLayer(marker);
         });
     }

    var band = ["20m", "17m","15m","12m","10m"];
    var beacons = [{name: '4U1UN', lat: 40.7501,   lon: -73.9682,  active: true},
                   {name: 'VE8AT', lat: 79.9949,   lon: -85.8451,  active: true},
                   {name: 'W6WX',  lat: 37.1599,   lon: -121.9083, active: true},
                   {name: 'KH6RS', lat: 20.7652,   lon: -156.3502, active: true},
                   {name: 'ZL6B',  lat: -41.04350, lon: 175.5952,  active: false},
                   {name: 'VK6RBP',lat: -32.1093,  lon: 116.0712,  active: true},
                   {name: 'JA2IGY',lat: 34.4613,   lon: 136.7818,  active: true},
                   {name: 'RR9O',  lat: 55.0484,   lon: 82.9227,   active: true},
                   {name: 'VR2B',  lat: 22.2705,   lon: 114.1507,  active: true},
                   {name: '4S7B',  lat: 6.8915,    lon: 79.8559,   active: true},
                   {name: 'ZS6DN', lat: -26.6531,  lon: 27.9474,   active: true},
                   {name: '5Z4B',  lat: -1.2687,   lon: 36.8094,   active: false},
                   {name: '4X6TU', lat: 32.0622,   lon: 34.8069,   active: true},
                   {name: 'OH2B',  lat: 60.2920,   lon: 24.3942,   active: true},
                   {name: 'CS3B',  lat: 32.8217,   lon: -17.2325,  active: true},
                   {name: 'LU4AA', lat: -34.6439,  lon: -58.4138,  active: true},
                   {name: 'OA4B',  lat: -12.0940,  lon: -77.0165,  active: true},
                   {name: 'YV5B',  lat: 9.0964,    lon: -67.8239,  active: true}]
    var currentBand="";
    var IBPLayer = L.layerGroup().addTo(map);
    var prevStationIndex = -1;

    function updateBeacon() {

       currentBandIndex = band.indexOf(currentBand);

       if ( currentBandIndex == -1 ) {
           IBPLayer.clearLayers();
           return;
       }

       var today = new Date();
       var n = Math.floor(today.getTime()/10000) % 18;
       var currentStationIndex = (18 + n - currentBandIndex) % 18;
       var nextStationIndex = (19 + n - currentBandIndex) % 18;

       if ( currentStationIndex == prevStationIndex ) {
           return;
       }

       IBPLayer.clearLayers();

       prevStationIndex = currentStationIndex;

       // show current
       var b = beacons[currentStationIndex]
       var color = '#FFFF33';
       if ( !b.active ) {
           color = 'red';
       }

       var marker = new L.marker([b.lat, b.lon], {opacity: 0.001 });
       marker.bindTooltip(b.name, {permanent: true, direction : 'bottom', offset: [-16, 8], className: 'muf-tooltip' });
       marker.getTooltip().setContent(`<div style="background-color: ${color};border-radius: 20px;padding: 5px;font-weight: bold;">${marker.getTooltip().getContent()}</div>`);
       IBPLayer.addLayer(marker);

       // show next
       b = beacons[nextStationIndex]
       color = '#1AA260';
       if ( !b.active ) {
          color = 'red';
       }
       marker = new L.marker([b.lat, b.lon], {opacity: 0.001 });
       marker.bindTooltip(b.name, {permanent: true, direction : 'bottom', offset: [-16, 8], className: 'muf-tooltip' });
       marker.getTooltip().setContent(`<div style="background-color: ${color};border-radius: 20px;padding: 5px;font-weight: bold;">${marker.getTooltip().getContent()}</div>`);
       IBPLayer.addLayer(marker);
    }

    setInterval(function(){updateBeacon()}, 250);

  </script>

</body>

</html>
